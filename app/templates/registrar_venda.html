{% extends "dashboard_base.html" %}

{% block dashboard_title %}Registrar Nova Venda{% endblock %}

{% block dashboard_content %}
<form id="formVenda" method="POST" action="{{ url_for('main.registrar_venda') }}">
    {{ form.hidden_tag() }}
    {{ form.itens_venda(id="itens_venda_input") }}

    <div class="row">
        <div class="col-md-7">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">1. Dados do Cliente</h5>
                    <div class="mb-3">
                        {{ form.cliente.label(class="form-label") }}
                        {{ form.cliente(class="form-select") }}
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">2. Adicionar Produtos</h5>
                    <div class="mb-3">
                        <input type="text" id="buscaProduto" class="form-control" placeholder="Buscar produto...">
                        <div id="listaResultados" class="list-group mt-2"></div>
                    </div>

                    <div id="detalhesProduto" class="d-none border p-3 rounded bg-light">
                        <h6 id="nomeProdutoSelecionado" class="text-primary fw-bold"></h6>
                        <div class="row">
                            <div class="col-6">Estoque: <strong id="estoqueAtual"></strong></div>
                            <div class="col-6">Preço: R$ <strong id="precoUnitario"></strong></div>
                        </div>
                        <div class="row mt-2 align-items-end">
                            <div class="col-4">
                                <label>Qtd:</label>
                                <input type="number" id="quantidadeVenda" class="form-control" value="1" min="1">
                            </div>
                            <div class="col-8">
                                <button type="button" id="btnAdicionarAoCarrinho" class="btn btn-success w-100">Incluir</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card">
                <div class="card-header bg-dark text-white">Resumo da Venda</div>
                <div class="card-body">
                    <ul id="carrinhoLista" class="list-group list-group-flush mb-3" style="max-height: 300px; overflow-y: auto;">
                        <li id="carrinhoVazio" class="list-group-item text-center text-muted">Carrinho vazio</li>
                    </ul>

                    <hr>

                    <div class="row mb-2">
                        <div class="col-6"><strong>Subtotal:</strong></div>
                        <div class="col-6 text-end"><span id="lblSubtotal">R$ 0.00</span></div>
                    </div>

                    <div class="mb-3 bg-light p-2 rounded border">
                        <div class="form-check form-switch">
                            {{ form.cobrar_taxa(class="form-check-input", id="chkTaxa") }}
                            <label class="form-check-label" for="chkTaxa">Aplicar Taxa de Maquininha</label>
                        </div>
                        
                        <div id="divTaxaInput" class="mt-2 d-none">
                            <label class="small">Percentual da Taxa (%):</label>
                            {{ form.percentual_taxa(class="form-control form-control-sm", id="inputTaxaPercentual", placeholder="Ex: 4.5") }}
                        </div>
                    </div>

                    <div class="row mb-2 text-danger" id="divValorTaxa" style="display:none;">
                        <div class="col-6">Desconto Taxa:</div>
                        <div class="col-6 text-end">- <span id="lblValorTaxa">R$ 0.00</span></div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-6"><h5 class="mb-0">Valor Líquido:</h5><small class="text-muted">(A Receber)</small></div>
                        <div class="col-6 text-end"><h4 id="lblTotalLiquido" class="fw-bold text-success mb-0">R$ 0.00</h4></div>
                    </div>

                    <div class="d-grid mt-4">
                        {{ form.submit(class="btn btn-primary btn-lg", id="btnFinalizar", disabled=true) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const formVenda = document.getElementById('formVenda');
    const buscaProdutoInput = document.getElementById('buscaProduto');
    const listaResultados = document.getElementById('listaResultados');
    const detalhesProdutoDiv = document.getElementById('detalhesProduto');
    const nomeProdutoSelecionado = document.getElementById('nomeProdutoSelecionado');
    const estoqueAtual = document.getElementById('estoqueAtual');
    const precoUnitario = document.getElementById('precoUnitario');
    const quantidadeVendaInput = document.getElementById('quantidadeVenda');
    const btnAdicionarAoCarrinho = document.getElementById('btnAdicionarAoCarrinho');
    const carrinhoLista = document.getElementById('carrinhoLista');
    const carrinhoVazio = document.getElementById('carrinhoVazio');
    const itensVendaInput = document.querySelector('input[name="itens_venda"]');
    const btnFinalizar = document.getElementById('btnFinalizar');

    let carrinho = [];
    let produtoSelecionado = null;

    // Log para depuração
    formVenda.addEventListener('submit', function(e) {
        console.log('Valor de itens_venda no momento do submit:', itensVendaInput.value);
    });

    // Função para buscar produtos
    buscaProdutoInput.addEventListener('input', function () {
        const termo = this.value;
        if (termo.length < 2) {
            listaResultados.innerHTML = '';
            return;
        }

        fetch(`{{ url_for('main.api_produtos') }}?termo=${termo}`)
            .then(response => response.json())
            .then(data => {
                listaResultados.innerHTML = '';
                data.forEach(produto => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.classList.add('list-group-item', 'list-group-item-action');
                    item.textContent = produto.nome;
                    item.addEventListener('click', function (e) {
                        e.preventDefault();
                        selecionarProduto(produto);
                    });
                    listaResultados.appendChild(item);
                });
            });
    });

    // Função para selecionar um produto
    function selecionarProduto(produto) {
        produtoSelecionado = produto;
        nomeProdutoSelecionado.textContent = produto.nome;
        estoqueAtual.textContent = produto.quantidade;
        precoUnitario.textContent = produto.preco.toFixed(2);
        quantidadeVendaInput.max = produto.quantidade;
        detalhesProdutoDiv.classList.remove('d-none');
        listaResultados.innerHTML = '';
        buscaProdutoInput.value = '';
    }

    // Função para adicionar ao carrinho
    btnAdicionarAoCarrinho.addEventListener('click', function () {
        if (!produtoSelecionado) return;

        const quantidade = parseInt(quantidadeVendaInput.value);
        if (quantidade <= 0 || quantidade > produtoSelecionado.quantidade) {
            alert('Quantidade inválida.');
            return;
        }

        // Verifica se o item já está no carrinho
        const itemExistente = carrinho.find(item => item.id === produtoSelecionado.id);
        if (itemExistente) {
            itemExistente.quantidade += quantidade;
        } else {
            carrinho.push({
                id: produtoSelecionado.id,
                nome: produtoSelecionado.nome,
                preco: produtoSelecionado.preco,
                quantidade: quantidade
            });
        }

        atualizarCarrinho();
        detalhesProdutoDiv.classList.add('d-none');
        produtoSelecionado = null;
    });

    // Função para atualizar o carrinho
    function atualizarCarrinho() {
        carrinhoLista.innerHTML = '';
        if (carrinho.length === 0) {
            carrinhoLista.appendChild(carrinhoVazio);
        } else {
            carrinho.forEach((item, index) => {
                const li = document.createElement('li');
                li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                li.innerHTML = `
                    <span>${item.nome} (Qtd: ${item.quantidade})</span>
                    <button type="button" class="btn btn-danger btn-sm" data-index="${index}">Remover</button>
                `;
                carrinhoLista.appendChild(li);
            });
        }

        // Atualiza o input hidden com os dados do carrinho
        itensVendaInput.value = JSON.stringify(carrinho);

        // Habilita/desabilita o botão de finalizar
        btnFinalizar.disabled = carrinho.length === 0;

        atualizarTotais();
    }

    // Event listener para remover item do carrinho
    carrinhoLista.addEventListener('click', function (e) {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.index) {
            const index = parseInt(e.target.dataset.index);
            carrinho.splice(index, 1);
            atualizarCarrinho();
        }
    });

    // Lógica de cálculo financeiro
    const chkTaxa = document.getElementById('chkTaxa');
    const divTaxaInput = document.getElementById('divTaxaInput');
    const inputTaxaPercentual = document.getElementById('inputTaxaPercentual');
    const divValorTaxa = document.getElementById('divValorTaxa');
    const lblSubtotal = document.getElementById('lblSubtotal');
    const lblValorTaxa = document.getElementById('lblValorTaxa');
    const lblTotalLiquido = document.getElementById('lblTotalLiquido');

    function atualizarTotais() {
        let totalBruto = 0;
        carrinho.forEach(item => {
            totalBruto += item.quantidade * item.preco;
        });

        let valorTaxa = 0;
        if (chkTaxa.checked) {
            const percentual = parseFloat(inputTaxaPercentual.value) || 0;
            valorTaxa = totalBruto * (percentual / 100);
        }

        const totalLiquido = totalBruto - valorTaxa;

        lblSubtotal.textContent = `R$ ${totalBruto.toFixed(2)}`;
        lblValorTaxa.textContent = `R$ ${valorTaxa.toFixed(2)}`;
        lblTotalLiquido.textContent = `R$ ${totalLiquido.toFixed(2)}`;

        if (chkTaxa.checked) {
            divTaxaInput.classList.remove('d-none');
            divValorTaxa.style.display = 'flex';
        } else {
            divTaxaInput.classList.add('d-none');
            divValorTaxa.style.display = 'none';
        }
    }

    chkTaxa.addEventListener('change', atualizarTotais);
    inputTaxaPercentual.addEventListener('input', atualizarTotais);

    // Inicializa o carrinho
    atualizarCarrinho();
});
</script>
{% endblock %}